import{o as g,_ as y}from"./index.8a58b007.js";import{C,q as D,r as S,s as _,w as k,x as I,y as b}from"./chart.js.00f608ba.js";import{L as x}from"./vue-chartjs.b3d57c2d.js";import{a as M}from"./chartjs-plugin-annotation.e3ca55a0.js";import{S as v,L as O,e as d,f as h,E as p,g as l,x as L,z as V,k as w,W as T,aj as W,ak as P}from"./@vue.ee679632.js";import{a as z}from"./lodash-es.d99d4c8c.js";import{at as A,n as c,am as R}from"./vuetify.65d833ec.js";import"./vuex.0eb68a2c.js";import"./date-fns.d38e1d55.js";import"./vue-atomic-docs.4f3653eb.js";import"./vue-router.ec64e966.js";import"./axios.eca6faa7.js";import"./axios-cache-interceptor.0956cad0.js";import"./cache-parser.124ebbb8.js";import"./fast-defer.b34f24de.js";import"./object-code.c2755e43.js";import"./@fortawesome.2cecc5e3.js";import"./@awesome.me.7dae7d79.js";import"./@kurkle.1fd9dacb.js";C.register(D,S,_,k,I,b,M);const u={components:{LineChart:x},props:{icCards:{type:Array,default:()=>[],required:!1},preferredCards:{type:Array,default:()=>[],required:!1},scanId:{type:String,required:!0}},data:()=>({chartInnerHeight:"200px",chartInnerWidth:"500px",chartInnerLeft:"14px",chartInnerTop:"0px",dragTarget:"tip",imageHeight:574,imageWidth:1937,isLoadingScanData:!1,isTrackingMouse:!1,keySide:"left",scanData:void 0,selectedIcCard:void 0,shoulderOffset:0,tipOffset:0}),computed:{chartData(){return{labels:this.scanData[this.keySide].profile.x,datasets:[{data:this.scanData[this.keySide].profile.y}]}},chartOptions(){const e=this.currentIcCard.axes.map(t=>this.formIcCardAnnotations(t)).flat();return{onResize:this.onChartResize,aspectRatio:this.imageWidth/this.imageHeight,elements:{line:{borderWidth:3,borderColor:"#00bcd4",tension:0},point:{pointStyle:!1}},scales:{x:{type:"linear",min:0,max:this.imageWidth,ticks:{stepSize:2}},y:{min:0,max:this.imageHeight,ticks:{stepSize:1}}},plugins:{title:{display:!1},legend:{display:!1},tooltip:{enabled:!1},annotation:{annotations:[{id:"shoulder_pos",type:"line",scaleID:"x",value:this.shoulderPosition,endValue:this.shoulderPosition,borderColor:"red",label:{position:"start",content:"Shoulder",display:!0}},{id:"end_of_key_pos",type:"line",scaleID:"x",value:this.tipPosition,endValue:this.tipPosition,borderColor:"red",label:{position:"start",content:"Tip",display:!0}},...e]}}}},currentIcCard:{get(){return this.selectedIcCard||this.icCardOptions[0]},set(e){this.selectedIcCard=e}},icCardOptions(){let e=[...this.preferredCards];return this.icCards.forEach(t=>{e.find(({cardNumber:n})=>n===t.cardNumber)||e.push(t)}),e},shoulderPosition(){return this.shoulderOffset+Math.max(this.scanData[this.keySide].datums.shoulder,0)},tipPosition(){return this.tipOffset+this.scanData[this.keySide].datums.tip}},mounted(){this.fetchScan()},methods:{async fetchScan(){this.isLoadingScanData=!0,this.scanData=void 0;try{const{data:e}=await g.fetchAlignedScans(this.scanId);this.scanData=e}catch(e){console.log(e)}this.isLoadingScanData=!1},formIcCardAnnotations(e){let t="bottom";e.verticalDatum==="left"?t="top":e.verticalDatum==="center"&&(t="centerLine");let i=this.scanData[this.keySide].datums[t],n=this.currentIcCard.horizontalDatum==="tip",o=n?this.tipPosition:this.shoulderPosition;return[...e.positions.map((a,r)=>{var s;return{id:`depth_pos_${r+1}`,type:"line",borderColor:"red",borderWidth:1,xMax:n?o-a:o+a,xMin:n?o-a:o+a,xScaleID:"x",yMin:this.scanData[this.keySide].datums.top+45,yMax:Math.min(...Object.values(e.depths))+i,yScaleID:"y",label:{position:"start",content:((s=e.directCode)==null?void 0:s.split("")[r])||"",display:!0}}}),...Object.entries(e.depths).map(([a,r])=>({id:`depths_${a}`,type:"line",borderColor:"red",borderWidth:1,xMax:Math.min(this.tipPosition+25,this.imageWidth),xMin:0,xScaleID:"x",yMin:r+i,yMax:r+i,yScaleID:"y",label:{position:"end",content:a,display:!0,backgroundColor:"rgba(0, 0, 0, 0)"}}))]},endDrag(){this.isTrackingMouse=!1},startDrag(){this.isTrackingMouse=!0},resetOffsets(){this.tipOffset=0,this.shoulderOffset=0},handleMouseDrag(e){if(this.isTrackingMouse){const t=this.imageWidth/parseFloat(this.chartInnerWidth),i=e.movementX*t;this.dragTarget==="tip"?this.tipOffset+=i:this.dragTarget==="shoulder"&&(this.shoulderOffset+=i)}},onChartResize(e){e.chartArea&&this.$nextTick(()=>{this.chartInnerHeight=e.chartArea.height+"px",this.chartInnerWidth=e.chartArea.width+"px",this.chartInnerLeft=e.chartArea.left+"px",this.chartInnerTop=e.chartArea.top+"px"})},onResize:z(function(){var e,t;(t=(e=this.$refs.lineChart)==null?void 0:e.chart)==null||t.resize()},300),setGraphAxes(){let e=new Image;e.src=this.scanData[this.keySide].images.front,this.imageWidth=e.width,this.imageHeight=e.height}}},m=()=>{T(e=>({"75fa166f":e.chartInnerHeight,"7ada4104":e.chartInnerWidth,dab65162:e.chartInnerLeft,"3647810d":e.chartInnerTop}))},f=u.setup;u.setup=f?(e,t)=>(m(),f(e,t)):m;const H=u,j=e=>(W("data-v-13d63526"),e=e(),P(),e),q={class:"scan-graph-car-key"},E={class:"scan-graph-car-key__side-selection"},G={key:0,class:"scan-graph-car-key__loader-container"},N=j(()=>p("div",{class:"w-100 text-center"}," Failed to load scan data ",-1)),B=["src"];function U(e,t,i,n,o,a){const r=v("LineChart");return O((d(),h("div",q,[p("div",E,[l(c,{modelValue:e.dragTarget,"onUpdate:modelValue":t[0]||(t[0]=s=>e.dragTarget=s),class:"flex-grow-0",items:["tip","shoulder"],label:"Drag Target",width:"100"},null,8,["modelValue"]),l(c,{modelValue:e.keySide,"onUpdate:modelValue":[t[1]||(t[1]=s=>e.keySide=s),a.resetOffsets],class:"flex-grow-0 ml-6",items:["left","right"],label:"Key Side",width:"100"},null,8,["modelValue","onUpdate:modelValue"]),a.icCardOptions.length?(d(),L(c,{key:0,modelValue:a.currentIcCard,"onUpdate:modelValue":t[2]||(t[2]=s=>a.currentIcCard=s),class:"flex-grow-0 ml-6",items:a.icCardOptions,"item-title":"cardNumber",label:"IC Card","return-object":"",width:"100"},null,8,["modelValue","items"])):V("",!0)]),e.isLoadingScanData||!e.scanData?(d(),h("div",G,[l(R,{type:"ossein",loading:e.isLoadingScanData,class:"scan-graph-car-key__loader"},{default:w(()=>[N]),_:1},8,["loading"])])):(d(),h("div",{key:1,class:"scan-graph-car-key__chart-container",onMousedown:t[4]||(t[4]=(...s)=>a.startDrag&&a.startDrag(...s)),onMousemove:t[5]||(t[5]=(...s)=>a.handleMouseDrag&&a.handleMouseDrag(...s)),onMouseleave:t[6]||(t[6]=(...s)=>a.endDrag&&a.endDrag(...s)),onMouseup:t[7]||(t[7]=(...s)=>a.endDrag&&a.endDrag(...s))},[p("img",{class:"scan-graph-car-key__key-image",src:e.scanData[e.keySide].images.front,onLoad:t[3]||(t[3]=(...s)=>a.setGraphAxes&&a.setGraphAxes(...s))},null,40,B),l(r,{ref:"lineChart",class:"scan-graph-car-key__line-chart",data:a.chartData,options:a.chartOptions},null,8,["data","options"])],32))])),[[A,a.onResize,void 0,{quiet:!0}]])}const ce=y(H,[["render",U],["__scopeId","data-v-13d63526"]]);export{ce as default};
